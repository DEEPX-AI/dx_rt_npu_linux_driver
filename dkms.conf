PACKAGE_NAME="dxrt-driver-dkms"
PACKAGE_VERSION="@DKMS_MODULE_VERSION@"

CLEAN="cd modules && make DEVICE=m1 PCIE=deepx clean"

MAKE="cd modules && make DEVICE=m1 PCIE=deepx KERNEL_DIR=/lib/modules/${kernelver}/build"

# INSTALL="cd modules && make DEVICE=m1 PCIE=deepx install KERNEL_DIR=/lib/modules/$(uname -r)/build"

# Pre-install hook: Only run during automatic kernel updates (not during package updates)
# Check if we're in automatic DKMS mode (not triggered by postinst)
PRE_INSTALL="if [ -z \"\$DKMS_PACKAGE_UPDATE\" ]; then \
if systemctl is-active --quiet dxrt 2>/dev/null; then systemctl stop dxrt || true; fi; \
if lsmod | grep -q '^dxrt_driver'; then rmmod -f dxrt_driver || true; fi; \
if lsmod | grep -q '^dx_dma'; then rmmod -f dx_dma || true; fi; \
fi"

# Post-install hook: Only run during automatic kernel updates
# Start service if it's enabled (system wants it to run automatically)
POST_INSTALL="if [ -z \"\$DKMS_PACKAGE_UPDATE\" ]; then \
modprobe dx_dma || true; modprobe dxrt_driver || true; \
if systemctl is-enabled --quiet dxrt 2>/dev/null; then systemctl start dxrt || true; fi; \
fi"

#dx_dma module ko
BUILT_MODULE_NAME[0]="dx_dma"
BUILT_MODULE_LOCATION[0]="modules/pci_deepx"
DEST_MODULE_LOCATION[0]="/updates/dkms"

#dxrt_driver module ko
BUILT_MODULE_NAME[1]="dxrt_driver"
BUILT_MODULE_LOCATION[1]="modules/rt"
DEST_MODULE_LOCATION[1]="/updates/dkms"

#Automatically builds and installs the module for new/updated kernels.
AUTOINSTALL="yes"

#kernel module dependency
MODPROBE_ALIAS_AND_DEPENDS="dxrt_driver dx_dma"
